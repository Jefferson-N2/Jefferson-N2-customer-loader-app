<h2 mat-dialog-title id="dialog-title">Información del Proceso</h2>

<mat-dialog-content class="dialog-content">
  <!-- Cargando -->
  <div *ngIf="isLoading$ | async" class="loading-container">
    <mat-spinner diameter="40"></mat-spinner>
    <p>Cargando información...</p>
  </div>

  <!-- Error -->
  <mat-card class="error-card" *ngIf="error$ | async as error">
    <mat-card-content>
      <mat-icon class="error-icon">error</mat-icon>
      <p>{{ error }}</p>
    </mat-card-content>
  </mat-card>

  <!-- Contenido -->
  <ng-container *ngIf="!(isLoading$ | async) && !(error$ | async)">
    <!-- Información General -->
    <div class="info-section">
      <div class="info-grid">
        <div class="info-item">
          <span class="label">ID Proceso:</span>
          <span class="value">{{ (processDetails$ | async)?.processId || 'N/A' }}</span>
        </div>
        <div class="info-item">
          <span class="label">Archivo:</span>
          <span class="value">{{ (processDetails$ | async)?.fileName || 'N/A' }}</span>
        </div>
        <div class="info-item">
          <span class="label">Estado:</span>
          <span class="value status" [ngClass]="'status-' + ((processDetails$ | async)?.status?.toLowerCase() || 'pending')">
            {{ ((processDetails$ | async)?.errorCount || 0) === 0 ? 'Sin errores' : 'Con errores' }}
          </span>
        </div>
        <div class="info-item">
          <span class="label">% Éxito:</span>
          <span class="value success-rate" [ngClass]="getSuccessPercentage() >= 80 ? 'high' : (getSuccessPercentage() >= 50 ? 'medium' : 'low')">
            {{ getSuccessPercentage() }}%
          </span>
        </div>
      </div>
    </div>

    <!-- Tabs con Errores y Clientes -->
    <mat-tab-group class="info-tabs">
      <!-- TAB: ERRORES -->
      <mat-tab label="Errores" *ngIf="(processDetails$ | async)?.errorCount! > 0">
        <ng-template mat-tab-label>
          <mat-icon class="tab-icon">warning</mat-icon>
          <span>Errores ({{ (processDetails$ | async)?.errorCount || 0 }})</span>
        </ng-template>

        <!-- Filtros de Errores -->
        <div class="filters-section">
          <mat-form-field class="filter-field">
            <mat-label>Buscar en mensajes</mat-label>
            <input
              matInput
              [value]="errorFilterIdType$ | async"
              (input)="errorFilterIdType$.next($event.target.value)"
              placeholder="Buscar por mensaje..."
            />
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>
        </div>

        <!-- Tabla de Errores -->
        <div class="table-wrapper" *ngIf="errors$ | async as errors">
          <table mat-table [dataSource]="errors.content" class="info-table">
            <!-- Columna: Línea -->
            <ng-container matColumnDef="lineNumber">
              <th mat-header-cell *matHeaderCellDef>Línea</th>
              <td mat-cell *matCellDef="let element">{{ element.lineNumber }}</td>
            </ng-container>

            <!-- Columna: Campo -->
            <ng-container matColumnDef="fieldName">
              <th mat-header-cell *matHeaderCellDef>Campo</th>
              <td mat-cell *matCellDef="let element">
                <span class="field-name-badge">{{ element.fieldName }}</span>
              </td>
            </ng-container>

            <!-- Columna: Mensaje -->
            <ng-container matColumnDef="errorMessage">
              <th mat-header-cell *matHeaderCellDef>Mensaje</th>
              <td mat-cell *matCellDef="let element">
                <span [matTooltip]="element.errorMessage" class="error-message">
                  {{ element.errorMessage }}
                </span>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="errorDisplayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: errorDisplayedColumns"></tr>
          </table>

          <!-- Paginador de Errores -->
          <mat-paginator
            *ngIf="errors.content.length > 0"
            [length]="errors.totalElements"
            [pageSize]="5"
            [pageSizeOptions]="[5, 10, 25]"
            (page)="onErrorPageChange($event)"
            aria-label="Paginador de errores"
            showFirstLastButtons
          ></mat-paginator>

          <!-- Sin errores -->
          <div class="empty-state" *ngIf="errors.content.length === 0">
            <mat-icon>check_circle</mat-icon>
            <p>Sin errores</p>
          </div>
        </div>
      </mat-tab>

      <!-- TAB: CLIENTES -->
      <mat-tab label="Clientes" *ngIf="(processDetails$ | async)?.successfulCount! > 0">
        <ng-template mat-tab-label>
          <mat-icon class="tab-icon">people</mat-icon>
          <span>Clientes ({{ (processDetails$ | async)?.successfulCount || 0 }})</span>
        </ng-template>

        <!-- Filtros de Clientes -->
        <div class="filters-section">
          <mat-form-field class="filter-field">
            <mat-label>Nombre</mat-label>
            <input
              matInput
              [value]="clientFilterName$ | async"
              (input)="clientFilterName$.next($event.target.value)"
              placeholder="Buscar por nombre..."
            />
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>

          <mat-form-field class="filter-field">
            <mat-label>Código</mat-label>
            <input
              matInput
              [value]="clientFilterCode$ | async"
              (input)="clientFilterCode$.next($event.target.value)"
              placeholder="Buscar por código..."
            />
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>
        </div>

        <!-- Tabla de Clientes -->
        <div class="table-wrapper" *ngIf="clients$ | async as clients">
          <table mat-table [dataSource]="clients.content" class="info-table">
            <!-- Columna: Código -->
            <ng-container matColumnDef="clientCode">
              <th mat-header-cell *matHeaderCellDef>Código</th>
              <td mat-cell *matCellDef="let element">{{ element.clientCode }}</td>
            </ng-container>

            <!-- Columna: Nombre -->
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>Nombre</th>
              <td mat-cell *matCellDef="let element">
                {{ element.firstNames }} {{ element.lastNames }}
              </td>
            </ng-container>

            <!-- Columna: Email -->
            <ng-container matColumnDef="email">
              <th mat-header-cell *matHeaderCellDef>Email</th>
              <td mat-cell *matCellDef="let element">
                <a [href]="'mailto:' + element.email">{{ element.email }}</a>
              </td>
            </ng-container>

            <!-- Columna: Teléfono -->
            <ng-container matColumnDef="phone">
              <th mat-header-cell *matHeaderCellDef>Teléfono</th>
              <td mat-cell *matCellDef="let element">{{ element.phoneNumber }}</td>
            </ng-container>

            <!-- Columna: Estado -->
            <ng-container matColumnDef="accountStatus">
              <th mat-header-cell *matHeaderCellDef>Estado</th>
              <td mat-cell *matCellDef="let element">
                <span class="status-badge" [ngClass]="'status-' + (element.account?.status?.toLowerCase() || 'unknown')">
                  {{ element.account?.status || 'N/A' }}
                </span>
              </td>
            </ng-container>

            <!-- Columna: Acciones -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Detalles</th>
              <td mat-cell *matCellDef="let element">
                <button
                  mat-icon-button
                  matTooltip="Ver detalles del cliente"
                  (click)="viewClientDetails(element)"
                  class="action-button"
                >
                  <mat-icon>info</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="clientDisplayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: clientDisplayedColumns"></tr>
          </table>

          <!-- Paginador de Clientes -->
          <mat-paginator
            *ngIf="clients.content.length > 0"
            [length]="clients.totalElements"
            [pageSize]="5"
            [pageSizeOptions]="[5, 10, 25]"
            (page)="onClientPageChange($event)"
            aria-label="Paginador de clientes"
            showFirstLastButtons
          ></mat-paginator>

          <!-- Sin clientes -->
          <div class="empty-state" *ngIf="clients.content.length === 0">
            <mat-icon>people_outline</mat-icon>
            <p>Sin clientes</p>
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>
  </ng-container>
</mat-dialog-content>

