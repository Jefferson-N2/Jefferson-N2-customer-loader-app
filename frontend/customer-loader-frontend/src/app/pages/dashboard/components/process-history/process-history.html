<div class="history-container" role="main">
  <!-- Encabezado -->
  <div class="history-header">
    <h2 id="history-title">Historial de Cargas</h2>
  </div>

  <!-- Filtros -->
  <div class="filters-section" role="search" aria-label="Filtros de búsqueda">
    <div class="filters-row">
      <mat-form-field class="filter-field">
        <mat-label>Estado</mat-label>
        <mat-select
          [value]="filterStatus$ | async"
          (selectionChange)="filterStatus$.next($event.value)"
          aria-label="Filtrar por estado"
        >
          <mat-option *ngFor="let option of statusOptions" [value]="option.value">
            {{ option.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field class="filter-field">
        <mat-label>Nombre de archivo</mat-label>
        <input
          matInput
          [value]="filterFileName$ | async"
          (change)="filterFileName$.next($event.target.value)"
          aria-label="Filtrar por nombre de archivo"
          placeholder="Buscar por nombre..."
        />
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <div class="filter-actions">
        <button
          mat-raised-button
          color="accent"
          (click)="reloadProcesses()"
          aria-label="Recargar procesos"
        >
          <mat-icon>refresh</mat-icon>
          Recargar
        </button>
        <button
          mat-stroked-button
          (click)="clearFilters()"
          aria-label="Limpiar filtros"
        >
          <mat-icon>clear</mat-icon>
          Limpiar filtros
        </button>
      </div>
    </div>
  </div>

  <!-- Tabla de Procesos -->
  <div
    class="history-table-container"
    *ngIf="processes$ | async as processes"
    role="region"
    aria-labelledby="history-title"
  >
    <table
      mat-table
      [dataSource]="processes.content"
      class="history-table"
      role="grid"
      aria-label="Tabla de historial de procesos de carga"
    >
      <!-- Columna: ID Proceso -->
      <ng-container matColumnDef="processId">
        <th mat-header-cell *matHeaderCellDef scope="col">ID Proceso</th>
        <td mat-cell *matCellDef="let element">
          <span class="process-id" [title]="element.processId">{{ element.processId }}</span>
        </td>
      </ng-container>

      <!-- Columna: Nombre Archivo -->
      <ng-container matColumnDef="fileName">
        <th mat-header-cell *matHeaderCellDef scope="col">Archivo</th>
        <td mat-cell *matCellDef="let element">{{ element.fileName }}</td>
      </ng-container>

      <!-- Columna: Total Registros -->
      <ng-container matColumnDef="totalRecords">
        <th mat-header-cell *matHeaderCellDef scope="col">Total</th>
        <td mat-cell *matCellDef="let element">{{ element.totalRecords }}</td>
      </ng-container>

      <!-- Columna: Exitosos -->
      <ng-container matColumnDef="successfulCount">
        <th mat-header-cell *matHeaderCellDef scope="col">Exitosos</th>
        <td mat-cell *matCellDef="let element">
          <span class="count count-success">{{ element.successfulCount }}</span>
        </td>
      </ng-container>

      <!-- Columna: Errores -->
      <ng-container matColumnDef="errorCount">
        <th mat-header-cell *matHeaderCellDef scope="col">Errores</th>
        <td mat-cell *matCellDef="let element">
          <span class="count count-error">{{ element.errorCount }}</span>
        </td>
      </ng-container>

      <!-- Columna: Fecha -->
      <ng-container matColumnDef="processingDate">
        <th mat-header-cell *matHeaderCellDef scope="col">Fecha</th>
        <td mat-cell *matCellDef="let element">
          {{ formatDate(element.processingDate) }}
        </td>
      </ng-container>

      <!-- Columna: Estado -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef scope="col">Estado</th>
        <td mat-cell *matCellDef="let element">
          <span
            class="status-badge"
            [ngClass]="'status-' + (element.status?.toLowerCase() || 'pending')"
            [attr.aria-label]="'Estado: ' + (element.status || 'N/A')"
          >
            {{ element.status || 'PENDING' }}
          </span>
        </td>
      </ng-container>

      <!-- Columna: Acciones -->
      <ng-container matColumnDef="acciones">
        <th mat-header-cell *matHeaderCellDef scope="col">Acciones</th>
        <td mat-cell *matCellDef="let element">
          <div class="actions">
            <button
              mat-icon-button
              matTooltip="Ver detalles"
              (click)="viewDetails(element.processId)"
              aria-label="Ver detalles del proceso"
            >
              <mat-icon>info</mat-icon>
            </button>
            <button
              mat-icon-button
              matTooltip="Ver clientes cargados"
              (click)="viewClients(element.processId)"
              aria-label="Ver clientes cargados del proceso"
              *ngIf="element.successfulCount > 0"
            >
              <mat-icon>people</mat-icon>
            </button>
            <button
              mat-icon-button
              matTooltip="Ver errores"
              (click)="viewErrors(element.processId)"
              aria-label="Ver errores del proceso"
              *ngIf="element.errorCount > 0"
            >
              <mat-icon>error</mat-icon>
            </button>
          </div>
        </td>
      </ng-container>

      <!-- Header y Rows -->
      <tr
        mat-header-row
        *matHeaderRowDef="displayedColumns"
        role="row"
      ></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns; trackBy: trackByProcessId"
        [attr.data-test]="'process-row-' + row.processId"
        role="row"
      ></tr>
    </table>

    <!-- Paginador -->
    <mat-paginator
      [length]="processes.totalElements"
      [pageSize]="pageSize"
      [pageSizeOptions]="pageSizeOptions"
      (page)="onPageChange($event)"
      showFirstLastButtons
      aria-label="Paginación de procesos"
    ></mat-paginator>
  </div>

  <!-- Cargando -->
  <div
    class="loading"
    *ngIf="isLoading$ | async"
    role="status"
    aria-label="Cargando historial"
  >
    <mat-spinner diameter="40" aria-hidden="true"></mat-spinner>
    <p>Cargando procesos...</p>
  </div>

  <!-- Vacío -->
  <ng-container *ngIf="processes$ | async as processes">
    <ng-container *ngIf="processes.content && processes.content.length === 0 && !(isLoading$ | async)">
      <mat-card class="empty-state" role="status">
        <mat-card-content>
          <mat-icon class="empty-icon" aria-hidden="true">history</mat-icon>
          <h3>Sin procesos</h3>
          <p>No hay procesos de carga registrados</p>
        </mat-card-content>
      </mat-card>
    </ng-container>
  </ng-container>

  <!-- Error -->
  <mat-card class="error-state" *ngIf="error$ | async as error" role="alert">
    <mat-card-content>
      <mat-icon class="error-icon" aria-hidden="true">error</mat-icon>
      <h3>Error al cargar historial</h3>
      <p>{{ error }}</p>
    </mat-card-content>
  </mat-card>
</div>
